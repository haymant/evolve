# Requirements Analysis
- Support **generic async transitions in run mode** (non-debug) with the same lifecycle as debug: start → pause → submit → resume.
- Run mode must surface **pending ops** to the VS Code host (status bar, `/jobs`, notifications, forms).
- Run mode must accept **submissions** via chat `/submit`, HTTP `POST /submit`, or UI form submit.
- Bridge must be secure: **per-run token**, local bind, and session scoping.
- Preserve debug DAP flow without changes.

# Feature Mapping
- **Existing (KB 000.00.001)**: Run-mode WebSocket bridge with env vars (`EVOLVE_RUN_BRIDGE_ADDR/TOKEN/SESSION`), request/response for `vscode/chat`, `vscode/showMessage`, etc.
- **Existing (KB 000.00.002)**: Engine async pause/resume with `PendingOp` and `submit_async`.
- **Existing (KB 000.00.003)**: Host pending ops store, async DAP event schema, and generic submit API.
- **Needed**:
	- Run-bridge **event channel** for async ops: `asyncOperationStarted`, `asyncOperationUpdated`, and `asyncOperationSubmit`.
	- Run-mode **server lifecycle** (start/stop) with session-aware routing.
	- **Bridge client** support for sending async events from Python runtime.
	- End-to-end **run-mode automation** tests using [examples/GenericAsync.evolve.yaml](examples/GenericAsync.evolve.yaml).

# System Design
## Architecture
- **Extension Host**: Run-bridge server (WS + HTTP), PendingOpsStore, UI surfaces, slash commands.
- **Python Runtime**: `vscode_bridge` run-bridge client, emits async op events, receives submit events.
- **Protocol**: Run-bridge envelopes mirror DAP async events for uniform handling.

## Run-Bridge Enhancements
### WS Event Types (new)
```json
{ "type": "dapEvent", "event": "asyncOperationStarted", "body": { ... }, "sessionId": "run-xyz" }
{ "type": "dapEvent", "event": "asyncOperationUpdated", "body": { ... }, "sessionId": "run-xyz" }
{ "type": "dapEvent", "event": "asyncOperationSubmit", "body": { ... }, "sessionId": "run-xyz" }
```

### HTTP Submit (existing, extend)
- `POST /submit` with `{ resumeToken, result }` must dispatch `asyncOperationSubmit` into run-bridge WS clients **and** update `PendingOpsStore`.

## Data Flow
1. **Engine hits async inscription** → creates `PendingOp` → emits `asyncOperationStarted` via run-bridge WS.
2. **Extension** receives event → registers in `PendingOpsStore` → status bar updates; notifications shown.
3. **User resumes**:
	 - Form submit → extension sends `asyncOperationSubmit` (WS or DAP-like event) to runtime.
	 - `/submit <token>` → same submit event.
	 - HTTP `POST /submit` → same submit event.
4. **Runtime** receives submit → calls `submit_async` → tokens emitted → run continues or pauses for next op.

## Security & Scoping
- **Per-run token** `EVOLVE_RUN_BRIDGE_TOKEN` required for all WS + HTTP requests.
- **SessionId** (`EVOLVE_RUN_BRIDGE_SESSION`) gates event routing to the correct run.
- Bind WS/HTTP to `127.0.0.1` only.

# Implementation Strategy
## Epic 000.00.004.1 – Run-Bridge Async Event Transport
**Story 1.1**: WS event support for async ops
- Task: Extend run-bridge server to accept `dapEvent` envelopes for async events.
- Task: Route `asyncOperationStarted/Updated` to `PendingOpsStore` using existing handler (shared with DAP).
- Task: Broadcast `asyncOperationSubmit` to all connected run clients for session.

**Story 1.2**: Python client emit async events
- Task: Extend `vscode_bridge` run-bridge client to send `dapEvent` envelopes.
- Task: Engine emits `asyncOperationStarted` on run-bridge when async op created.

## Epic 000.00.004.2 – Run-Mode UX Integration
**Story 2.1**: Pending ops UI in run mode
- Task: Ensure PendingOpsStore updates from run-bridge events.
- Task: Status bar and notifications update in run mode.

**Story 2.2**: Run-mode submit routes
- Task: Wire `/submit` and `evolve.submitOperation` to run-bridge when active run session.
- Task: Keep HTTP `/submit` handler consistent with run-bridge event routing.

## Epic 000.00.004.3 – Run-Mode Lifecycle & Diagnostics
**Story 3.1**: Bridge lifecycle
- Task: Start run-bridge on `evolve.runNet` and pass env vars to run process.
- Task: Graceful shutdown when run ends; clear pending ops for session.

**Story 3.2**: Diagnostics
- Task: Output banner with run-bridge addr/session in run terminal.
- Task: Expose debug logs for async event routing.

# Testing Strategy
## Unit Tests (Python)
- Validate `vscode_bridge` run-bridge client:
	- Serialize `dapEvent` for `asyncOperationStarted`.
	- Submit routing for `asyncOperationSubmit`.
	- Timeout / token auth failure behavior.

## Extension Unit Tests
- PendingOpsStore updates via run-bridge event handler (reuse same handler as DAP).
- `POST /submit` updates store and dispatches submit event.

## VS Code Automation Tests
- Add a run-mode test that uses [examples/GenericAsync.evolve.yaml](examples/GenericAsync.evolve.yaml):
	- Start `evolve.runNet` (noDebug) with run-bridge enabled.
	- Assert PendingOpsStore has a pending op after first transition.
	- Use `/submit <token>` and assert pending clears and next op appears.
- Add a test for HTTP submit:
	- Issue `POST /submit` to run-bridge and assert pending clears.

## Acceptance Criteria
- In **run mode**, async ops create PendingOpsStore entries and update status bar.
- `/jobs` lists pending ops during run-mode async pause.
- `/submit` and HTTP submit resume execution and advance tokens.
- Debug mode behavior remains unchanged.
