# 000.01.003 Code Generation & Execution

# Requirements Analysis
- Implement `codegen.generate` that converts PNML (transitions and inscriptions) into runnable Python artifacts (scripts or package) with metadata (entrypoint, files, dependencies).
- Implement `runtime.run_in_venv` to select or create a Python venv, run the generated artifact, and capture logs and exit codes.
- Ensure safety (timeout, package allowlist) and sandboxing per guardrails.

# Feature Mapping
- Maps to existing design docs: `kb/2.designPattern/codeGen.md` and `kb/2.designPattern/codeExeVenv.md`.
- Add modules: `codegen/adapter.py` and `runtime/runner.py`.

# System Design
- `codegen.generate(pnml)` -> { files: {path: content}, entrypoint: path, requirements: [] }
- `runtime.run_in_venv(code_artifact, options)` -> { run_id, stdout, stderr, exit_code, start_time, end_time }
- Safety checks performed pre-run.

# Implementation Strategy
Stories and tests:

3.1 Story: Implement `codegen.generate` adapter
- Tasks:
  - Implement mapping of PNML transition inscriptions (python expressions) to files; create an entrypoint that wires transitions.
- Unit tests:
  - `test_codegen_generates_files` (asserts files include entrypoint and transition modules).
  - `test_codegen_includes_requirements` (when transitions require packages include them).
- Test data: `samples/pnml/simple_print.yaml` (single transition that prints "hello").

3.2 Story: Implement `runtime.run_in_venv`
- Tasks:
  - Implement venv selection (choose workspace venv or create ephemeral venv in tempdir).
  - Implement run wrapper to execute the entrypoint process with timeout and capture stdout/stderr.
- Unit tests (using a simple script):
  - `test_runtime_runs_success` (script prints and returns 0).
  - `test_runtime_times_out` (script sleeps longer than timeout and results in timeout error).
- Test data: `samples/code/simple_echo.py`, `samples/code/long_sleep.py`.

3.3 Story: Safety & sandboxing
- Tasks:
  - Enforce package allowlist and timeout in `runtime.runner`.
- Unit tests:
  - `test_runtime_block_disallowed_package` (script importing banned package raises an error).

# Testing Strategy
- Integration test: `tests/integration/test_pnml_to_run.py`
  - Steps:
    1. Use `samples/pnml/simple_print.yaml` to run through `codegen.generate` -> artifact -> `runtime.run_in_venv`.
    2. Assert run results: exit_code == 0 and stdout contains expected string.
  - Test data: `samples/pnml/simple_print.yaml`.

---

# Automation
- Place runtime tests behind an integration tag since creation of venvs and running code may require CI runner permissions.
