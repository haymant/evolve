# Async Lambda + HTTP Operations (Host E2E)

## Goal
Implement end-to-end support for `vscode_bridge.lambda_async(...)` and `vscode_bridge.http_async(...)` so that async transitions can be started by the engine, surfaced in the VS Code host, resumed via host-managed execution or HTTP callbacks, and finalized in the engine with result tokens.

## Requirements Analysis
- Host must receive async operations with `operationType: lambda` or `operationType: http_endpoint` and create resumable tasks.
- Host must expose a secure resume endpoint for HTTP callbacks.
- Lambda operations must execute a host-side worker or external job and submit results.
- Resume tokens must be single-use and time-bound.
- Engine must receive results through `asyncOperationSubmit` and resume workflow deterministically.
- Provide user visibility: pending list, status bar updates, errors surfaced.

## Feature Mapping
- **Existing**: Generic async operation lifecycle, run-bridge, pending ops store, and engine pending ops support.
- **Missing**:
	- Lambda registry/runner in host.
	- HTTP `/submit` resume endpoint wiring + validation.
	- Automated tests for lambda/http operations.

## System Design
### Data Model
- `PendingOp` with `operationType` = `lambda` | `http_endpoint`, `resumeToken`, `operationParams`, `timeoutMs`.
- `operationParams`:
	- `lambda`: `{ name: string, args: any[] }`
	- `http_endpoint`: `{ url: string, method: string }`

### Host Lifecycle
1. Engine emits `asyncOperationStarted` event with `operationType` and `resumeToken`.
2. Host registers pending op and surfaces to UI.
3. Lambda:
	 - Host runs a local worker (registry handler) or dispatches to external job.
	 - On completion, host calls `asyncOperationSubmit` with `operationId|resumeToken` and `result`.
4. HTTP:
	 - Host exposes `POST /submit` and validates token.
	 - External caller posts `{ resumeToken, result }`.
	 - Host forwards submit to engine.
5. Engine resumes and emits result tokens to output places.

### Security and Validation
- Bind HTTP endpoint to localhost only.
- Require `EVOLVE_RUN_BRIDGE_TOKEN` per request.
- Validate resume token ownership and single-use.
- Enforce timeouts, emit error tokens on timeout.

## Implementation Strategy
### Epic 1: Lambda Worker Registry
**Story**: Provide a registry for lambda workers in the VS Code extension.
- Tasks:
	- Add `LambdaRegistry` with `register(name, handler)`.
	- Add default no-op handler with clear error if unknown.
	- Execute handler in background and submit result via run-bridge.

### Epic 2: HTTP Resume Endpoint
**Story**: Expose `POST /submit` with token validation.
- Tasks:
	- Extend run-bridge HTTP server handler for `/submit`.
	- Validate token + session; return 404/409 for invalid/used tokens.
	- Forward `asyncOperationSubmit` to engine.

### Epic 3: UI + Observability
**Story**: Surface lambda/http ops in pending list and status bar.
- Tasks:
	- Ensure `PendingOpsStore` shows `operationType` and `operationParams`.
	- Add quick-pick details and error notifications.

### Epic 4: Automated Tests
**Story**: Add unit and integration coverage for lambda/http.
- Tasks:
	- Unit test: pending op lifecycle for lambda/http.
	- Integration test: run-bridge submit for lambda/http.
	- E2E test: `examples/GenericAsync.evolve.yaml` flow.

## Testing Strategy
### Unit Tests
- `PendingOpsStore` registers lambda/http ops correctly.
- `LambdaRegistry` resolves handlers and errors on unknown handler.
- Submit token validation rejects invalid or reused tokens.

### Integration Tests
- Start run-bridge server, simulate `asyncOperationStarted`, submit result, assert engine resumes.
- HTTP `/submit` accepts valid token and rejects invalid token.

### End-to-End Tests
- Use [examples/GenericAsync.evolve.yaml](../../examples/GenericAsync.evolve.yaml):
	- `t_lambda` completes via host lambda handler.
	- `t_http` completes via HTTP callback.

## Acceptance Criteria
- Lambda ops complete and resume without manual intervention.
- HTTP ops can be resumed with a valid resume token.
- Tokens appear in downstream places as expected.
- Errors/timeouts are surfaced and do not deadlock the engine.
