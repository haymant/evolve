# 000.01.002 PNML First-Version Policy

# Requirements Analysis
- Implement a policy engine that decides whether newly generated PNML should use async participant transitions or deterministic templates.
- Enforce: default to `execMode: async` with `participant_async` unless a deterministic template exists for a given subtask.
- Ensure at least one deterministic transition exists in first-version PNML for validation (e.g., a schema-check transition).

# Feature Mapping
- New policy module: `policy/first_version.py` responsible for selection logic.
- Ties into `pnml_generator` so the generator uses the policy output to shape transition `evolve.kind` and `execMode`.

# System Design
- Policy service provides `choose_mode(node, templates)` -> {"mode": "async"|"deterministic", "template_id": <opt>}.
- Template registry (`templates/`) contains deterministic inscriptions and selection metadata.

# Implementation Strategy
Stories and tests:

2.1 Story: Implement template registry
- Tasks:
  - Add a `templates/` directory and a loader `templates/registry.py`.
- Unit tests:
  - `test_registry_loads_templates` (loads sample templates).
  - `test_template_lookup` (returns matching template for node type).
- Test data: `templates/sample_validate_template.yaml` (transition to run a simple schema check).

2.2 Story: Implement `policy.first_version` selection logic
- Tasks:
  - Implement selection with fallbacks and a hook to ensure at least one deterministic element.
- Unit tests:
  - `test_policy_prefers_template` (if template exists, select deterministic).
  - `test_policy_defaults_to_async` (if no template choose async).
  - `test_policy_inserts_validation_transition` (ensure one deterministic is present).
- Test data: sample node lists with and without templates.

2.3 Story: Integrate policy decision into `pnml_generator`
- Tasks:
  - Update generator to accept `policy` decisions and produce PNML accordingly.
- Unit tests:
  - `test_generator_honors_policy`.

# Testing Strategy
- Integration test: `tests/integration/test_policy_end_to_end.py`
  - Steps:
    1. Provide an ideation that maps to nodes where templates exist and where they don't.
    2. Run `pnml_generator` with the policy module configured.
    3. Validate the resulting PNML schema and assert at least one deterministic transition exists.
  - Test data: `samples/ideation/valid_with_template.json` and `samples/ideation/valid_without_template.json`.

---

# Automation
- Run unit tests in CI; integration test run on PR merge to main or periodically to verify template coverage.
